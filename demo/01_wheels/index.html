<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,minimum-scale=1,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="http://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="./turntable.js"></script>
    <title>抽奖</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <script src="airtable.js"></script>
    <style>
        #myCanvas {
            border: none !important;
        }

        .lottery {
            position: relative;
            display: inline-block;
            width: 100%;
            text-align: center;
        }

        .lottery img {
            position: absolute;
            top: 48%;
            left: 50%;
            transform: translateY(-48%) translateX(-50%);
            cursor: pointer;
            width: 50px;
        }

        #message {
            position: absolute;
            top: 0px;
            left: 10%;
        }

        .container {
            position: relative;
            display: inline-block;
            width: 100%;
            text-align: center;
            margin-top: 20px;
        }

        #gallery {
            display: none;
        }

    </style>
    <!--[if lte IE 8]>
        <style>
            .lottery img{
                display: none;
            }   
        </style>
    <![endif]-->
</head>

<body>
    <div class="wrapper">
        <div class="container">
            <div class="text-left">
                <img src="images/logo.png" class="logo">
                <h1 class="mainTitle">LUCKY<br>WHEEL</h1>
                <h3>TCI 幸运转盘</h3>
            </div>
        </div>
        <div class="lottery">
            <canvas id="myCanvas" width="350" height="350" style="border:1px solid #d3d3d3;">
                当前浏览器版本过低，请使用其他浏览器尝试
            </canvas>
            <p id="message"></p>
            <img src="./images/start.png">
        </div>

        <div class="container" id="prizeListContainer">
            <div class="row">
                <div class="col-auto text-left">
                    A奖项
                </div>
                <div class="col text-right">
                    TCI血橙胶原蛋白饮一盒
                </div>
            </div>
            <div class="row">
                <div class="col-auto text-left">
                    B奖项
                </div>
                <div class="col text-right">
                    TCI花凝系列面膜一片
                </div>
            </div>
            <div class="row">
                <div class="col-auto text-left">
                    C奖项
                </div>
                <div class="col text-right">
                    TCI内服外养套组一盒
                </div>
            </div>
        </div>
        <div class="footer">
            <div class="wrapper">
                <a href="javascript:;" id="start" class="button">试试手气</a>
            </div>
        </div>
    </div>

    <script>
        var wheelSurf
        // 初始化装盘数据 正常情况下应该由后台返回
        var initData = {
            "success": true,
            "list": [{
                    "id": 100,
                    "name": "A奖项",
                    "prize": "恭喜您，现场获得TCI血橙胶原蛋白饮一盒！",
                    "image": "./images/1.png",
                    "rank": 1,
                    "percent": 20
                },
                {
                    "id": 101,
                    "name": "B奖项",
                    "prize": "恭喜您，现场获得TCI花凝系列面膜一片！",
                    "image": "./images/1.png",
                    "rank": 2,
                    "percent": 15
                },
                {
                    "id": 102,
                    "name": "A奖项",
                    "prize": "恭喜您，现场获得TCI血橙胶原蛋白饮一盒！",
                    "image": "",
                    "rank": 3,
                    "percent": 20
                },
                {
                    "id": 103,
                    "name": "B奖项",
                    "prize": "恭喜您，现场获得TCI花凝系列面膜一片！",
                    "image": "./images/1.png",
                    "rank": 4,
                    "percent": 15
                },
                {
                    "id": 104,
                    "name": "C奖项",
                    "prize": "恭喜您，现场获得TCI内服外养套组一盒！",
                    "image": "./images/3.png",
                    "rank": 5,
                    "percent": 20
                },
                {
                    "id": 105,
                    "name": "未中奖",
                    "prize": "未中奖，感谢您的参与！",
                    "image": "./images/4.png",
                    "rank": 6,
                    "percent": 10
                }
            ]
        }

        // 计算分配获奖概率(前提所有奖品概率相加100%)
        function getGift() {
            var percent = Math.random() * 100
            var totalPercent = 0
            for (var i = 0, l = initData.list.length; i < l; i++) {
                totalPercent += initData.list[i].percent
                if (percent <= totalPercent) {
                    return initData.list[i]
                }
            }
        }

        var list = {}

        var angel = 360 / initData.list.length
        // 格式化成插件需要的奖品列表格式
        for (var i = 0, l = initData.list.length; i < l; i++) {
            list[initData.list[i].rank] = {
                id: initData.list[i].id,
                name: initData.list[i].name,
                nameEg: initData.list[i].nameEg,
                nameEg2: initData.list[i].nameEg2,
                image: initData.list[i].image
            }
        }
        // 查看奖品列表格式

        // 定义转盘奖品
        wheelSurf = $('#myCanvas').WheelSurf({
            list: list, // 奖品 列表，(必填)
            outerCircle: {
                color: '#fff' // 外圈颜色(可选)
            },
            innerCircle: {
                color: '#f4ad26' // 里圈颜色(可选)
            },
            dots: ['#B4B4B4'], // 装饰点颜色(可选)
            disk: ['#CC6914', '#EB7714', '#f0974c'], //中心奖盘的颜色，默认7彩(可选)
            title: {
                color: '#fff',
                font: '19px Arial'
            } // 奖品标题样式(可选)
        })

        // 初始化转盘
        wheelSurf.init()
        //AirTable
        let tCode = window.location.href.split('?tCode=')[1],
            Airtable = require('airtable'),
            base = new Airtable({
                apiKey: 'keyAZHw39lMlDtr2O'
            }).base('appl3OSLwSjvTtjFO');
        retrieveMsg();

        function retrieveMsg() {
            base('record').select({
                maxRecords: 1,
                view: "Grid view",
                fields: ["tCode", "result"],
                filterByFormula: "{tCode} = '" + tCode + "'"
            }).eachPage(function page(records, fetchNextPage) {

                if (records.length === 0) {
                    //                    $('#q0').show()
                } else {
                    records.forEach(function(record) {
                        let reult = record.get('result');
                        alert(reult)
                        console.log('tCode = ', record.get('tCode'));
                    });
                }

                fetchNextPage();

            }, function done(err) {
                if (err) {
                    console.error(err);
                    return;
                }
            });
        }
        // 抽奖
        var throttle = true;
        $("#start").on('click', function() {

            var winData = getGift() // 正常情况下获奖信息应该由后台返回

            $("#message").html('')
            if (!throttle) {
                return false;
            }
            throttle = false;
            var count = 0
            // 计算奖品角度

            for (const key in list) {
                if (list.hasOwnProperty(key)) {
                    if (winData.id == list[key].id) {
                        break;
                    }
                    count++
                }
            }

            // 转盘抽奖，
            wheelSurf.lottery((count * angel + angel / 2), function() {
                alert(winData.prize)
                if (tCode == undefined) {
                    console.log('just playing')
                } else {
                    base('record').create([{
                        "fields": {
                            "tCode": tCode,
                            "result": winData.name
                        }
                    }], function(err) {
                        if (err) {
                            console.error(err);
                        } else {}
                    });
                }
                throttle = true;
            })
        })

    </script>
</body>

</html>
